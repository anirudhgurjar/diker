var app = angular.module('dikerApp', []);


app.config(function($locationProvider) {
    $locationProvider.html5Mode({
      enabled: true,
      requireBase: false
    });
});

app.controller('compCtrl', function($scope,$location,$http ) {
    $scope.Login={};
    $scope.Jobs={};
    $scope.errmsg='a';
    $scope.token="";
    $scope.jpost={};
    $scope.frmName="";
    $scope.dispJob={};
    $scope.appliedCanLst={};


        $scope.getMyJobs=function(){
          //  alert(JSON.stringify($location.search()['token']));
            $scope.token=$location.search()['token'];
            $http({
                     method : "POST",                
                    url : "http://localhost:8080/api/org/jobs/list/anirudh",
                     headers: {'x-access-token': $scope.token}                                             
                     //data:  {email: $scope.Login.email, password: $scope.Login.password},                  
                }).success(function(data, status, headers, config) {  
                              $scope.Jobs=data;
                              var i=0;
                              angular.forEach($scope.Jobs,function(key,value){                                
                          //        var cnt=$scope.getAppCount(key._id);
                                 // key.push({'count':cnt});
       //                          alert("coint is" +cnt);
                              //   $scope.Jobs[i].count=cnt;
                              //  alert(JSON.stringify($scope.Jobs[i].count));
                                  i++;
                              });
                        //      alert(JSON.stringify($scope.Jobs));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );
        }


        $scope.getAppCount=function(jid,index){
            $scope.token=$location.search()['token'];
            $http({
                     method : "POST",                
                    url : "http://localhost:8080/api/org/jobs/getappcount/",
                     headers: {'x-access-token': $scope.token},                                             
                     data:  {job_id: jid},                  
                }).success(function(data, status, headers, config) {  
                                  $scope.Jobs[index].count=data.count;
    
     // return (data.count);

                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );
        }


$scope.downloadCV=function(docId){
            $scope.token=$location.search()['token'];
            $http({
                     method : "POST",                
                    url : "http://localhost:8080/downloadCV/"+docId,
                     headers: {'x-access-token': $scope.token}                                             
                   //  data:  {'doc_id': docId},                  
                }).success(function(data, status, headers, config) {  
                  if (data != null && navigator.msSaveBlob)
		              return navigator.msSaveBlob(new Blob([data], { type: "data:attachment/text" }), "resume.docx");
                      var a = $("<a style='display: none;'/>");
                      var url = window.URL.createObjectURL(new Blob([data], {type: "data:attachment/text"}));
                      a.attr("href", url);
                      a.attr("download", name);
                      $("body").append(a);
                      a[0].click();
                      window.URL.revokeObjectURL(url);
                      a.remove();
                            }). error(function(data, status, headers, config) {
                                   alert('unable to download')
                                }
                         );
        }

        $scope.postJob=function(){
            alert(JSON.stringify($scope.jpost));
            $scope.token=$location.search()['token'];
            var job={"job": $scope.jpost };
            $http({
                     method : "POST",                
                    url : "http://localhost:8080/api/org/jobs/add",
                     headers: {'x-access-token': $scope.token, 'Content-Type': 'application/json'} ,                                                                 
                     data: job                  
                }).success(function(data, status, headers, config) {
                            if(data.success==true){  
                                alert("Job posed");
                                navLink="http://localhost:8080/comp_dash?token="+$scope.token; 
                                  window.location=navLink;
                            }
                            if(data.success==false){  
                                alert("Error in posting job");
                            }
                            }). error(function(data, status, headers, config) {
                                   alert("Error in posting job");
                                }
                         );

        }

$scope.loadApplications=function(){

$scope.frmName='jobappl.htm';
}



            $scope.dispDtls=function(job){
                    $scope.dispJob=job;
                    $scope.frmName='comp_jobdtls.htm';
                    $scope.token=$location.search()['token'];
            }


$scope.lstJobsByJobId=function(job_id){

            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/jobsapp/listbyjobid";
                    
            $http({
                     method : "POST",                
                    url : url,
                     headers: {'x-access-token': $scope.token},
                     data: {'job_id': job_id}
                }).success(function(data, status, headers, config) {  
                            //  $scope.Jobs=data;                              
                              $scope.appliedCanLst=data;
                            //  $scope.tmpls=data;
                          //  alert(JSON.stringify($scope.appliedCanLst));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );

                        
}

});