var app = angular.module('dikerApp', []);


app.config(function($locationProvider) {
    $locationProvider.html5Mode({
      enabled: true,
      requireBase: false
    });
});

app.controller('agencyCtrl', function($scope,$location,$http,$filter) {
    $scope.Login={};
    $scope.joblst={};
    $scope.errmsg='a';
    $scope.token="";
    $scope.jpost={};
    $scope.frmName="";
    $scope.findFrm={};
    $scope.dispJob={};
    $scope.profile={};
    $scope.postUrl="";
$scope.pid="-1";
$scope.lstCan={};
$scope.fltrAppls={};
$scope.fltrCan={};
$scope.tmpls=[];
$scope.showApplyFrm="-1";
$scope.appliedCanLst=[];
$scope.dashData=[];

        $scope.findJobs=function(){
          //  alert(JSON.stringify($location.search()['token']));
            $scope.token=$location.search()['token'];
            $http({
                     method : "POST",                
                    url : "http://localhost:8080/api/jobs/find/",
                     headers: {'x-access-token': $scope.token},                                             
                    data:  {q: $scope.findFrm.q, loc: $scope.findFrm.loc},                  
                }).success(function(data, status, headers, config) {  
                              $scope.Jobs=data;
                              alert(JSON.stringify(data));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );
        }


        $scope.postJob=function(){
            alert(JSON.stringify($scope.jpost));
            $scope.token=$location.search()['token'];
            var job={"job": $scope.jpost };
            $http({
                     method : "POST",                
                    url : "http://localhost:8080/api/org/jobs/add",
                     headers: {'x-access-token': $scope.token, 'Content-Type': 'application/json'} ,                                                                 
                     data: job                  
                }).success(function(data, status, headers, config) {
                            if(data.success==true){  
                                alert("Job posed");
                                navLink="http://localhost:8080/comp_dash?token="+$scope.token; 
                                  window.location=navLink;
                            }
                            if(data.success==false){  
                                alert("Error in posting job");
                            }
                            }). error(function(data, status, headers, config) {
                                   alert("Error in posting job");
                                }
                         );

        }

    $scope.loadApplications=function(){
                $scope.frmName='jobappl.htm';
                $scope.token=$location.search()['token'];
    }

    $scope.viewJobDetails=function(jobId){
                
             $scope.dispJob= $filter('filter')($scope.joblst, {_id: jobId})[0];
            // alert(JSON.stringify(dispJob));
               $scope.frmName='jobdtls.htm';
               $scope.token=$location.search()['token'];
    }

    $scope.viewJobDetailsFrmHome=function(job){
                
             $scope.dispJob= job;//$filter('filter')($scope.joblst, {_id: jobId})[0];
            // alert(JSON.stringify(dispJob));
               $scope.frmName='jobdtls.htm';
               $scope.token=$location.search()['token'];
    }


    $scope.refineAppls=function(flts,value){
       
        if(flts==='fname'){
                $scope.fltrCan={'fname':value};
        }else if(flts==='phone'){ 
                $scope.fltrCan={'phone':value};
        }else if(flts==='email'){
                $scope.fltrCan={'email':value};
        }else if(flts==='$'){
                $scope.fltrCan={};
        }else if(flts==='skillset'){
                $scope.fltrCan={'skillset':value};
        }


           //    $scope.frmName='jobdtls.htm';
            //   $scope.token=$location.search()['token'];
    }


$scope.sayhi=function(){
            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/jobs/find/"+$scope.findFrm.q;          
            $http({
                     method : "POST",                
                    url : url,
                     headers: {'x-access-token': $scope.token}                                             
                                   
                }).success(function(data, status, headers, config) {  
                            //  $scope.Jobs=data;                              
                              $scope.joblst=data;
                            //  alert(JSON.stringify($scope.joblst));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );
}

$scope.lstApplicants=function(){

            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/vendor/profile/list";          
            $http({
                     method : "POST",                
                    url : url,
                     headers: {'x-access-token': $scope.token}                                             
                                   
                }).success(function(data, status, headers, config) {  
                            //  $scope.Jobs=data;                              
                              $scope.lstCan=data;
                              $scope.tmpls=data;
                           //  alert(JSON.stringify($scope.lstCan));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );
}

$scope.getMyJobs=function(){

            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/jobsapp/vendordash";          
            $http({
                     method : "POST",                
                    url : url,
                     headers: {'x-access-token': $scope.token}                                             
                                   
                }).success(function(data, status, headers, config) {  
                            //  $scope.Jobs=data;                              
                              $scope.dashData=data;
                            //  $scope.tmpls=data;
                           //  alert(JSON.stringify($scope.lstCan));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );
}

$scope.lstJobsByJobId=function(job_id){

            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/jobsapp/listbyvendor";
                    
            $http({
                     method : "POST",                
                    url : url,
                     headers: {'x-access-token': $scope.token},
                     data: {'job_id': job_id}
                }).success(function(data, status, headers, config) {  
                            //  $scope.Jobs=data;                              
                              $scope.appliedCanLst=data;
                            //  $scope.tmpls=data;
                          //  alert(JSON.stringify($scope.appliedCanLst));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );

                        
}

$scope.deleteJobApp=function(app_id,dispJob_id){

            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/jobsapp/delete/"+app_id;
                    
            $http({
                     method : "POST",                
                    url : url,
                     headers: {'x-access-token': $scope.token},
                    data: {'app_id': app_id}
                }).success(function(data, status, headers, config) {  
                            //  $scope.Jobs=data;                              
                           alert('Application deleted');
                           $scope.lstJobsByJobId(dispJob_id);
                            //  $scope.tmpls=data;
                            //alert(JSON.stringify($scope.appliedCanLst));
                            }). error(function(data, status, headers, config) {
                                     $scope.errmsg=data.message;
                                }
                         );

                      //   alert('called');
}


$scope.addProfile=function(){
 //   alert('called');
            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/vendor/profile/add";   
            var prof={"profile": $scope.profile };       
              $scope.postUrl="http://localhost:8080/api/upload/token=" +$scope.token;
            $http({
                    method : "POST",                
                    url : url,
                    headers: {'x-access-token': $scope.token, 'Content-Type': 'application/json'} ,                                                                 
                    data: prof   
                }).success(function(data, status, headers, config) {
                            if(data.success==true){  
                                alert("Profile Added");
                                navLink="http://localhost:8080/agency_dash?token="+$scope.token; 
                                $scope.pid=data.pid;
                                //  window.location=navLink;
                            }
                            if(data.success==false){  
                                alert("Error in posting profile");
                            }
                            }). error(function(data, status, headers, config) {
                                   alert("Error in posting job");
                                }
                         );

}



$scope.submitApp=function(can_id,job_id,org_id){
 // alert(can_id + " " + job_id);
            $scope.token=$location.search()['token'];
            var url="http://localhost:8080/api/jobs/apply";   
            var rate=window.prompt("Enter expected salary(only $ value)");
            var prof={"jobapply": { 'job_id' :job_id , 'org_id':org_id, 'profile_id':can_id, 'rate':rate } };    
         
              $scope.postUrl="http://localhost:8080/api/jobs/apply";
            $http({
                    method : "POST",                
                    url : url,
                    headers: {'x-access-token': $scope.token, 'Content-Type': 'application/json'} ,                                                                 
                    data: prof   
                }).success(function(data, status, headers, config) {
                            if(data.success==true){  
                            alert("application Submitted");
                               $scope.lstJobsByJobId(job_id);
                           //     navLink="http://localhost:8080/agency_dash?token="+$scope.token; 
                             //   $scope.pid=data.pid;
                                //  window.location=navLink;
                            }
                            if(data.success==false){  
                                alert("Error in applying ." + data.msg);
                            }
                            }). error(function(data, status, headers, config) {
                                   alert("Error in applying, Please retry");
                                }
                         );
                               

}

$scope.loadForApply=function(){
            $scope.showApplyFrm="1";
           
}


});